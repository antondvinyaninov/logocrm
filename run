#!/usr/bin/env zsh

# Ğ¦Ğ²ĞµÑ‚Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ PHP 8.5.1 Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ
export PATH="/opt/homebrew/bin:$PATH"
PHP_BIN="/opt/homebrew/bin/php"

# ĞŸĞ¾Ñ€Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
LARAVEL_PORT=8000
VITE_PORT=5173

echo "${BLUE}ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ»Ğ¾Ğ³Ğ¾Ğ¿ĞµĞ´Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ñ†ĞµĞ½Ñ‚Ñ€Ğ°...${NC}\n"

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¸ Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ñ€Ñ‚Ğ°
check_and_free_port() {
    local port=$1
    local service_name=$2
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ·Ğ°Ğ½ÑÑ‚ Ğ»Ğ¸ Ğ¿Ğ¾Ñ€Ñ‚
    if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1 ; then
        echo "${YELLOW}âš ï¸  ĞŸĞ¾Ñ€Ñ‚ $port ($service_name) Ğ·Ğ°Ğ½ÑÑ‚${NC}"
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ PID Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ°
        local pid=$(lsof -ti:$port)
        
        if [ ! -z "$pid" ]; then
            echo "${YELLOW}   Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ PID: $pid${NC}"
            kill -9 $pid 2>/dev/null
            sleep 1
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ¸Ğ»ÑÑ Ğ»Ğ¸ Ğ¿Ğ¾Ñ€Ñ‚
            if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1 ; then
                echo "${RED}âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ñ€Ñ‚ $port${NC}"
                return 1
            else
                echo "${GREEN}âœ… ĞŸĞ¾Ñ€Ñ‚ $port Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´Ñ‘Ğ½${NC}"
            fi
        fi
    else
        echo "${GREEN}âœ… ĞŸĞ¾Ñ€Ñ‚ $port ($service_name) ÑĞ²Ğ¾Ğ±Ğ¾Ğ´ĞµĞ½${NC}"
    fi
    return 0
}

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸ Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ñ€Ñ‚Ñ‹
echo "${BLUE}ğŸ“¡ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ²...${NC}"
check_and_free_port $LARAVEL_PORT "Laravel"
check_and_free_port $VITE_PORT "Vite"
echo ""

# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ .env.local Ğ´Ğ»Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
if [ -f .env.local ]; then
    echo "${BLUE}ğŸ“ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ .env.local Ğ´Ğ»Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸${NC}"
    cp .env.local .env
    echo "${GREEN}âœ… ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°${NC}\n"
elif [ ! -f .env ]; then
    echo "${YELLOW}âš ï¸  Ğ¤Ğ°Ğ¹Ğ» .env Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½, ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ· .env.example${NC}"
    cp .env.example .env
    $PHP_BIN artisan key:generate
    echo "${GREEN}âœ… Ğ¤Ğ°Ğ¹Ğ» .env ÑĞ¾Ğ·Ğ´Ğ°Ğ½${NC}\n"
fi

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
if [ ! -f database/database.sqlite ]; then
    echo "${YELLOW}âš ï¸  Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°, ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼...${NC}"
    touch database/database.sqlite
    $PHP_BIN artisan migrate --seed
    echo "${GREEN}âœ… Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ¸ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°${NC}\n"
fi

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºÑƒ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
if [ ! -d "vendor" ]; then
    echo "${YELLOW}âš ï¸  Composer Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹${NC}"
    echo "${BLUE}ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ composer Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸...${NC}"
    composer install
    echo "${GREEN}âœ… Composer Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹${NC}\n"
fi

if [ ! -d "node_modules" ]; then
    echo "${YELLOW}âš ï¸  NPM Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹${NC}"
    echo "${BLUE}ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ npm Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸...${NC}"
    npm install
    echo "${GREEN}âœ… NPM Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹${NC}\n"
fi

# ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ĞºÑÑˆ Laravel
echo "${BLUE}ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ĞºÑÑˆĞ°...${NC}"
$PHP_BIN artisan config:clear
$PHP_BIN artisan cache:clear
$PHP_BIN artisan view:clear
$PHP_BIN artisan route:clear
echo "${GREEN}âœ… ĞšÑÑˆ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½${NC}\n"

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
echo "${BLUE}ğŸ“ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹...${NC}"
if $PHP_BIN artisan storage:link 2>&1 | grep -q "already exists"; then
    echo "${GREEN}âœ… Symbolic link ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚${NC}"
else
    $PHP_BIN artisan storage:link
    echo "${GREEN}âœ… Symbolic link ÑĞ¾Ğ·Ğ´Ğ°Ğ½${NC}"
fi
echo ""

# ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ IP Ğ°Ğ´Ñ€ĞµÑ
LOCAL_IP=$(ipconfig getifaddr en0 2>/dev/null || ipconfig getifaddr en1 2>/dev/null || echo "127.0.0.1")

# Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ²ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
echo "${GREEN}ğŸ‰ Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²...${NC}\n"
echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${GREEN}Laravel:${NC}"
echo "  Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾:  http://localhost:$LARAVEL_PORT"
echo "  Ğ’ ÑĞµÑ‚Ğ¸:    http://$LOCAL_IP:$LARAVEL_PORT"
echo "${GREEN}Vite:${NC}"
echo "  Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾:  http://localhost:$VITE_PORT"
echo "  Ğ’ ÑĞµÑ‚Ğ¸:    http://$LOCAL_IP:$VITE_PORT"
echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
echo "${YELLOW}Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸:${NC}"
echo "  SuperAdmin:     superadmin@logoped.test / password"
echo "  Ğ’Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ†:       owner@rechevichok.ru / password"
echo "  Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚:     specialist@logoped.test / password"
echo "  Ğ Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒ:       parent@logoped.test / password"
echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
echo "${YELLOW}Ğ”Ğ»Ñ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ctrl+C${NC}\n"

# Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ concurrently Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼Ğ¸
npx concurrently -c "#93c5fd,#c4b5fd,#fb7185,#fdba74" \
    "$PHP_BIN artisan serve --host=0.0.0.0 --port=$LARAVEL_PORT" \
    "$PHP_BIN artisan queue:listen --tries=1" \
    "$PHP_BIN artisan pail --timeout=0" \
    "npm run dev" \
    --names=server,queue,logs,vite \
    --kill-others
